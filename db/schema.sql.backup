-- Create database first
CREATE DATABASE IF NOT EXISTS flight_booking;
USE flight_booking;

-- Users table (no dependencies)
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Flights table (no foreign key dependencies)
CREATE TABLE flights (
    id INT AUTO_INCREMENT PRIMARY KEY,
    flight_number VARCHAR(10) UNIQUE NOT NULL,
    airline VARCHAR(100) NOT NULL,
    departure_city VARCHAR(100) NOT NULL,
    arrival_city VARCHAR(100) NOT NULL,
    departure_time DATETIME NOT NULL,
    arrival_time DATETIME NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    total_seats INT NOT NULL,
    available_seats INT NOT NULL
);

-- Now create seats table (depends on flights)
CREATE TABLE seats (
    id INT AUTO_INCREMENT PRIMARY KEY,
    flight_id INT,
    seat_number VARCHAR(10) NOT NULL,
    class ENUM('economy', 'business', 'first') DEFAULT 'economy',
    is_available BOOLEAN DEFAULT TRUE,
    price_multiplier DECIMAL(3,2) DEFAULT 1.00,
    FOREIGN KEY (flight_id) REFERENCES flights(id) ON DELETE CASCADE
);

-- Bookings table (depends on users, flights, and seats)
CREATE TABLE bookings (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    flight_id INT,
    seat_id INT,
    booking_reference VARCHAR(20) UNIQUE NOT NULL,
    total_amount DECIMAL(10,2) NOT NULL,
    booking_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status ENUM('confirmed', 'cancelled', 'pending') DEFAULT 'confirmed',
    passenger_name VARCHAR(100) NOT NULL,
    passenger_email VARCHAR(100) NOT NULL,
    passenger_phone VARCHAR(20),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (flight_id) REFERENCES flights(id) ON DELETE CASCADE,
    FOREIGN KEY (seat_id) REFERENCES seats(id) ON DELETE CASCADE
);

-- Payments table (depends on bookings)
CREATE TABLE payments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    booking_id INT,
    payment_method VARCHAR(50) NOT NULL,
    payment_status ENUM('pending', 'completed', 'failed') DEFAULT 'pending',
    transaction_id VARCHAR(100),
    amount DECIMAL(10,2) NOT NULL,
    payment_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE CASCADE
);

-- Insert sample flights first
INSERT INTO flights (flight_number, airline, departure_city, arrival_city, departure_time, arrival_time, price, total_seats, available_seats) VALUES
('AA123', 'American Airlines', 'New York', 'Los Angeles', '2024-02-01 08:00:00', '2024-02-01 11:00:00', 299.99, 180, 180),
('UA456', 'United Airlines', 'Chicago', 'Miami', '2024-02-01 14:30:00', '2024-02-01 17:45:00', 199.99, 180, 180),
('DL789', 'Delta Airlines', 'San Francisco', 'Seattle', '2024-02-01 09:15:00', '2024-02-01 11:30:00', 149.99, 180, 180);

-- Then insert seats for those flights
INSERT INTO seats (flight_id, seat_number, class, price_multiplier) VALUES
(1, '1A', 'first', 3.0),
(1, '1B', 'first', 3.0),
(1, '1C', 'first', 3.0),
(1, '10A', 'business', 2.0),
(1, '10B', 'business', 2.0),
(1, '10C', 'business', 2.0),
(1, '20A', 'economy', 1.0),
(1, '20B', 'economy', 1.0),
(1, '20C', 'economy', 1.0),
(2, '1A', 'first', 3.0),
(2, '1B', 'first', 3.0),
(2, '10A', 'business', 2.0),
(2, '10B', 'business', 2.0),
(2, '20A', 'economy', 1.0),
(2, '20B', 'economy', 1.0),
(3, '1A', 'first', 3.0),
(3, '1B', 'first', 3.0),
(3, '10A', 'business', 2.0),
(3, '10B', 'business', 2.0),
(3, '20A', 'economy', 1.0),
(3, '20B', 'economy', 1.0);
